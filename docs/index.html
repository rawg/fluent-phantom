<!DOCTYPE html>

<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A fluent DSL for scraping web content using <a href="http://phantomjs.org/">PhantomJS</a> 
and the <a href="https://github.com/sgentle/phantomjs-node">PhantomJS bridge for Node</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We require EventEmitter to be inherited by Request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Emitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Duration to make time outs friendlier</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Duration = <span class="hljs-built_in">require</span>(<span class="hljs-string">'duration-js'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>A helper to provide the current time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">now</span> = -&gt;</span>
    (<span class="hljs-keyword">new</span> Date).getTime()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The module exports are defined in this function to make it easy to inject a 
mock for unit testing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">binder</span> = <span class="hljs-params">(phantom)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Use the real PhantomJS bridge if an alternative is not injected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    phantom = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> phantom == <span class="hljs-string">'object'</span> <span class="hljs-keyword">then</span> phantom <span class="hljs-keyword">else</span> <span class="hljs-built_in">require</span> <span class="hljs-string">'phantom'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Connection strategies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhantomStrategy</span></span>
        <span class="hljs-attribute">port</span>: <span class="hljs-number">12340</span>
        <span class="hljs-attribute">supportsAutoClose</span>: <span class="hljs-literal">false</span>
        <span class="hljs-attribute">open</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>  <span class="hljs-comment"># phantom.create((ph) -&gt; )</span>
        <span class="hljs-attribute">exit</span>:<span class="hljs-function"> -&gt;</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewPhantomStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PhantomStrategy</span></span>
        <span class="hljs-attribute">phantom</span>: <span class="hljs-literal">null</span>
        <span class="hljs-attribute">supportsAutoClose</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">open</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            phantom.create {<span class="hljs-attribute">port</span>: <span class="hljs-property">@port</span>}, <span class="hljs-function"><span class="hljs-params">(ph)</span> =&gt;</span>
                <span class="hljs-property">@phantom</span> = ph
                callback ph
        <span class="hljs-attribute">exit</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@phantom</span>.exit()


    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewPortPhantomStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PhantomStrategy</span></span>
        <span class="hljs-attribute">phantom</span>: <span class="hljs-literal">null</span>
        <span class="hljs-attribute">supportsAutoClose</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">open</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            phantom.create {<span class="hljs-attribute">port</span>: <span class="hljs-property">@port</span>++}, <span class="hljs-function"><span class="hljs-params">(ph)</span> =&gt;</span>
                <span class="hljs-property">@phantom</span> = ph
                callback ph
        <span class="hljs-attribute">exit</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@phantom</span>.exit()
    
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RecycledPhantomStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PhantomStrategy</span></span>
        <span class="hljs-attribute">phantom</span>: <span class="hljs-literal">null</span>
        <span class="hljs-attribute">open</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@phantom</span>?
                phantom.create <span class="hljs-function"><span class="hljs-params">(ph)</span> =&gt;</span>
                    <span class="hljs-property">@phantom</span> = ph
                    callback ph
            <span class="hljs-keyword">else</span>
                callback <span class="hljs-property">@phantom</span>

        <span class="hljs-attribute">exit</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@phantom</span>.exit()

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PooledPhantomStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PhantomStrategy</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@size</span> = <span class="hljs-number">4</span>, <span class="hljs-property">@queueDepth</span> = <span class="hljs-number">4</span>)</span> -&gt;</span>
            <span class="hljs-property">@pool</span> = []
            <span class="hljs-property">@busy</span> = []
            <span class="hljs-property">@created</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># Number of connections created; used to keep ports unique</span>
            <span class="hljs-property">@queue</span> = []
            <span class="hljs-property">@timer</span> = []
            <span class="hljs-property">@timeout</span> = <span class="hljs-number">5000</span> <span class="hljs-comment"># ms to wait before releasing and recreating a connection</span>
            <span class="hljs-property">@interval</span> = <span class="hljs-literal">null</span>

            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@size</span>]
                <span class="hljs-property">@busy</span>[i] = <span class="hljs-literal">false</span>
                <span class="hljs-property">@timer</span>[i] = <span class="hljs-literal">null</span>
                <span class="hljs-property">@queue</span>[i] = []

            <span class="hljs-function"><span class="hljs-title">tick</span> = =&gt;</span>
                <span class="hljs-keyword">for</span> index, begin <span class="hljs-keyword">in</span> <span class="hljs-property">@timer</span>
                    <span class="hljs-keyword">if</span> begin <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
                        <span class="hljs-keyword">if</span> now() - begin &gt; <span class="hljs-property">@timeout</span>
                            <span class="hljs-property">@busy</span>[index] = <span class="hljs-literal">false</span>
                            <span class="hljs-property">@timer</span>[index] = <span class="hljs-literal">null</span>
                            <span class="hljs-property">@pool</span>[index] = <span class="hljs-literal">null</span>
                            <span class="hljs-property">@create</span> index

            <span class="hljs-property">@interval</span> = setInterval tick, Math.floor(<span class="hljs-property">@timeout</span> / <span class="hljs-number">4</span>)

        <span class="hljs-attribute">fill</span>: <span class="hljs-function"><span class="hljs-params">(upto = <span class="hljs-property">@size</span>)</span> -&gt;</span>
            <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..upto]
                <span class="hljs-property">@create</span> index

        <span class="hljs-attribute">create</span>: <span class="hljs-function"><span class="hljs-params">(index)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> index &lt; <span class="hljs-property">@size</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> <span class="hljs-property">@pool</span>[index] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> !<span class="hljs-property">@busy</span>[index]
                <span class="hljs-property">@busy</span>[index] = <span class="hljs-literal">true</span>
                phantom.create {<span class="hljs-attribute">port</span>: <span class="hljs-property">@port</span> + <span class="hljs-property">@created</span>++}, <span class="hljs-function"><span class="hljs-params">(ph)</span> =&gt;</span>
                    <span class="hljs-property">@pool</span>[index] = ph
                    <span class="hljs-property">@busy</span>[index] = <span class="hljs-literal">false</span>
                    <span class="hljs-property">@ready</span>(index)

        <span class="hljs-attribute">ready</span>: <span class="hljs-function"><span class="hljs-params">(index)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-property">@queue</span>[index].length &gt; <span class="hljs-number">0</span>
                callback = <span class="hljs-property">@queue</span>[index].shift()
                <span class="hljs-property">@exec</span>(index, callback)
        
        <span class="hljs-attribute">finished</span>: <span class="hljs-function"><span class="hljs-params">(index)</span> -&gt;</span>
            <span class="hljs-property">@timer</span>[index] = <span class="hljs-literal">null</span>
            <span class="hljs-property">@busy</span>[index] = <span class="hljs-literal">false</span>
            <span class="hljs-property">@ready</span>(index)

        <span class="hljs-attribute">exit</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@size</span>]
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> <span class="hljs-property">@pool</span>[idx] <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
                    <span class="hljs-property">@pool</span>[idx].exit()

        <span class="hljs-attribute">exec</span>: <span class="hljs-function"><span class="hljs-params">(index, callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-property">@busy</span>[index]
                <span class="hljs-keyword">if</span> <span class="hljs-property">@queue</span>[index].length &lt; <span class="hljs-property">@queueDepth</span> - <span class="hljs-number">1</span>
                    <span class="hljs-property">@queue</span>[index].push callback
                <span class="hljs-keyword">else</span>
                    pos = <span class="hljs-number">0</span>
                    min = Infinity
                    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@size</span>]
                        min = Math.min min, <span class="hljs-property">@queue</span>[pos].length

                    <span class="hljs-keyword">if</span> min &gt;= <span class="hljs-property">@queueDepth</span>
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Easy trigger, you're issuing too many requests. These things take time!"</span>)
                    <span class="hljs-keyword">else</span>
                        <span class="hljs-property">@queue</span>[pos].push callback

            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@busy</span>[index] = <span class="hljs-literal">true</span>
                <span class="hljs-property">@timer</span>[index] = now()
                <span class="hljs-function"><span class="hljs-title">done</span> = =&gt;</span>
                    <span class="hljs-property">@finished</span>(index)

                callback(<span class="hljs-property">@pool</span>[index], done)


        <span class="hljs-attribute">getIndex</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-number">0</span> <span class="hljs-comment"># Implement this in child classes!</span>
            
        <span class="hljs-attribute">open</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            index = <span class="hljs-property">@getIndex</span>()
            <span class="hljs-property">@create</span> index
            <span class="hljs-property">@exec</span> index, callback



    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoundRobinPhantomStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PooledPhantomStrategy</span></span>
        <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(size, min, queueDepth)</span> -&gt;</span>
            <span class="hljs-keyword">super</span>(size, queueDepth)
            <span class="hljs-property">@cursor</span> = <span class="hljs-number">0</span>

            <span class="hljs-keyword">if</span> min?
                <span class="hljs-property">@fill</span>(min)
       
        <span class="hljs-attribute">getIndex</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span> &gt;= <span class="hljs-property">@size</span>
                <span class="hljs-property">@cursor</span> = <span class="hljs-number">0</span>
            <span class="hljs-property">@cursor</span>++

                
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomPhantomStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PooledPhantomStrategy</span></span>
        <span class="hljs-attribute">getIndex</span>:<span class="hljs-function"> -&gt;</span> Math.floor Math.random() * <span class="hljs-property">@size</span>

    connection = <span class="hljs-keyword">new</span> NewPhantomStrategy()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Events that may be emitted by a Request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    events =
        <span class="hljs-attribute">HALT</span>: <span class="hljs-string">'halted'</span>
        <span class="hljs-attribute">PHANTOM_CREATE</span>: <span class="hljs-string">'phantom-created'</span>
        <span class="hljs-attribute">PAGE_CREATE</span>: <span class="hljs-string">'page-created'</span>
        <span class="hljs-attribute">PAGE_OPEN</span>: <span class="hljs-string">'page-opened'</span>
        <span class="hljs-attribute">TIMEOUT</span>: <span class="hljs-string">'timeout'</span>
        <span class="hljs-attribute">REQUEST_FAILURE</span>: <span class="hljs-string">'failed'</span>
        <span class="hljs-attribute">READY</span>: <span class="hljs-string">'ready'</span>
        <span class="hljs-attribute">FINISH</span>: <span class="hljs-string">'finished'</span>
        <span class="hljs-attribute">CHECKING</span>: <span class="hljs-string">'checking'</span>
        <span class="hljs-attribute">CONSOLE</span>: <span class="hljs-string">'console'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Default values for the request builder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    builders =
        <span class="hljs-attribute">when</span>:
            <span class="hljs-attribute">css</span>: <span class="hljs-string">'when-css'</span>
            <span class="hljs-attribute">function</span>: <span class="hljs-string">'when-func'</span>
            <span class="hljs-attribute">none</span>: <span class="hljs-string">'when-none'</span>
        <span class="hljs-attribute">action</span>:
            <span class="hljs-attribute">css</span>: <span class="hljs-string">'action-css'</span>
            <span class="hljs-attribute">parts</span>: <span class="hljs-string">'action-parts'</span>
            <span class="hljs-attribute">evaluate</span>: <span class="hljs-string">'action-evaluate'</span>
            <span class="hljs-attribute">function</span>: <span class="hljs-string">'action-function'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Allowable DOM node properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    nodeProperties = [<span class="hljs-string">'attributes'</span>, <span class="hljs-string">'baseURI'</span>, <span class="hljs-string">'childElementCount'</span>, <span class="hljs-string">'childNodes'</span>
        ,<span class="hljs-string">'classList'</span>, <span class="hljs-string">'className'</span>, <span class="hljs-string">'dataset'</span>, <span class="hljs-string">'dir'</span>, <span class="hljs-string">'hidden'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'innerHTML'</span>
        ,<span class="hljs-string">'innerText'</span>, <span class="hljs-string">'lang'</span>, <span class="hljs-string">'localName'</span>, <span class="hljs-string">'namespaceURI'</span>, <span class="hljs-string">'nodeName'</span>, <span class="hljs-string">'nodeType'</span>
        ,<span class="hljs-string">'nodeValue'</span>, <span class="hljs-string">'outerHTML'</span>, <span class="hljs-string">'outerText'</span>, <span class="hljs-string">'prefix'</span>, <span class="hljs-string">'style'</span>, <span class="hljs-string">'tabIndex'</span>
        ,<span class="hljs-string">'tagName'</span>, <span class="hljs-string">'textContent'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'type'</span>, <span class="hljs-string">'value'</span>, <span class="hljs-string">'children'</span>, <span class="hljs-string">'href'</span>
        ,<span class="hljs-string">'src'</span>
    ]</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>A fluent builder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Builder</span></span>
        <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@_build</span> =
                <span class="hljs-attribute">when</span>: builders.<span class="hljs-keyword">when</span>.none
                <span class="hljs-attribute">action</span>: builders.action.<span class="hljs-reserved">function</span>
            
            <span class="hljs-property">@_props</span> = 
                <span class="hljs-attribute">condition</span>:
                    <span class="hljs-attribute">callback</span>: <span class="hljs-literal">null</span>
                    <span class="hljs-attribute">argument</span>: <span class="hljs-literal">null</span>
                <span class="hljs-attribute">action</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">console</span>.log <span class="hljs-string">"No default action provided"</span>
                <span class="hljs-attribute">scraper</span>:
                    <span class="hljs-attribute">extractor</span>: <span class="hljs-literal">null</span>
                    <span class="hljs-attribute">handler</span>: <span class="hljs-literal">null</span>
                    <span class="hljs-attribute">argument</span>: <span class="hljs-literal">null</span>
                    <span class="hljs-attribute">properties</span>: [<span class="hljs-string">'children'</span>, <span class="hljs-string">'tagName'</span>, <span class="hljs-string">'innerText'</span>, <span class="hljs-string">'innerHTML'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'attributes'</span>, <span class="hljs-string">'href'</span>, <span class="hljs-string">'src'</span>, <span class="hljs-string">'className'</span>]
                    <span class="hljs-attribute">query</span>: <span class="hljs-literal">null</span>
                <span class="hljs-attribute">timeout</span>:
                    <span class="hljs-attribute">duration</span>: <span class="hljs-number">3000</span>
                    <span class="hljs-attribute">handler</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Timeout"</span>
                <span class="hljs-attribute">url</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Set a timeout duration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">until</span>: <span class="hljs-function"><span class="hljs-params">(timeout)</span> -&gt;</span> <span class="hljs-property">@for</span> timeout
        <span class="hljs-attribute">timeout</span>: <span class="hljs-function"><span class="hljs-params">(timeout)</span> -&gt;</span> <span class="hljs-property">@for</span> timeout
        <span class="hljs-attribute">for</span>: <span class="hljs-function"><span class="hljs-params">(timeout)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> timeout <span class="hljs-keyword">is</span> <span class="hljs-string">'number'</span>
                <span class="hljs-property">@_props</span>.timeout.duration = timeout
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> timeout <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
                <span class="hljs-property">@_props</span>.timeout.duration = Duration.parse(timeout).milliseconds()
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> timeout <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> timeout <span class="hljs-keyword">instanceof</span> Duration
                <span class="hljs-property">@_props</span>.timeout.duration = Duration.milliseconds()
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Expected timeout to be a number"</span>
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Never timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">forever</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@for</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Timeout after one tick</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">immediately</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@for</span> <span class="hljs-number">100</span>

        <span class="hljs-attribute">otherwise</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Expected timeout handler to be a function"</span>
            <span class="hljs-property">@_props</span>.timeout.handler = callback
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Set the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">url</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span> <span class="hljs-property">@from</span> url
        <span class="hljs-attribute">from</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> url <span class="hljs-keyword">isnt</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Expected URL to be a string"</span>
            <span class="hljs-property">@_props</span>.url = url
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Create an action to be run using Phantomâ€™s <code>page.evaluate</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">evaluate</span>: <span class="hljs-function"><span class="hljs-params">(scraper, handler, argument)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> scraper <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Expected scraping function"</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> handler <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Expected handler function"</span>
            
            <span class="hljs-property">@_build</span>.action = builders.action.evaluate

            <span class="hljs-property">@_props</span>.<span class="hljs-function"><span class="hljs-title">action</span> = <span class="hljs-params">(page)</span> -&gt;</span> page.evaluate scraper, handler, argument
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Run a generic action that receives a Phantom page object as its only argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">invoke</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span> <span class="hljs-property">@run</span>(callback)
        <span class="hljs-attribute">run</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Expected action to be a function"</span>
            <span class="hljs-property">@_build</span>.action = builders.action.<span class="hljs-reserved">function</span>
            <span class="hljs-property">@_props</span>.action = callback
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Assign a condition that must be satisfied before scraping content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">when</span>: <span class="hljs-function"><span class="hljs-params">(condition, argument)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> condition <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
                <span class="hljs-property">@_build</span>.<span class="hljs-keyword">when</span> = builders.<span class="hljs-keyword">when</span>.css

                minimum = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> argument <span class="hljs-keyword">is</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">then</span> argument <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
                <span class="hljs-property">@_props</span>.condition = 
                    <span class="hljs-attribute">callback</span>: <span class="hljs-function"><span class="hljs-params">(args)</span> -&gt;</span> <span class="hljs-built_in">document</span>.querySelectorAll(args.query).length &gt;= args.minimum
                    <span class="hljs-attribute">argument</span>:
                        <span class="hljs-attribute">minimum</span>: minimum
                        <span class="hljs-attribute">query</span>: condition

            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> condition <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
                <span class="hljs-property">@_build</span>.<span class="hljs-keyword">when</span> = builders.<span class="hljs-keyword">when</span>.<span class="hljs-reserved">function</span>

                <span class="hljs-property">@_props</span>.condition =
                    <span class="hljs-attribute">callback</span>: condition

                <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> argument <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
                    <span class="hljs-property">@_props</span>.condition.argument = argument

            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid condition"</span>

            @</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Select content on the page by either a CSS selector or a function to run
in the context of the page with access to <code>window</code> and <code>document</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">extract</span>: <span class="hljs-function"><span class="hljs-params">(selector, argument)</span> -&gt;</span> <span class="hljs-property">@select</span>(selector, argument)
        <span class="hljs-attribute">select</span>: <span class="hljs-function"><span class="hljs-params">(selector, argument)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> selector <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
                <span class="hljs-property">@_build</span>.action = builders.action.css
                <span class="hljs-property">@_props</span>.scraper.query = selector
                <span class="hljs-property">@when</span> selector, argument

            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> selector <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
                <span class="hljs-property">@_build</span>.action = builders.action.parts
                <span class="hljs-property">@_props</span>.scraper.extractor = selector

            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid selector"</span>

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> argument <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span>
                <span class="hljs-property">@_props</span>.scraper.argument = argument

            @</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Describe how to handle scraped results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">process</span>: <span class="hljs-function"><span class="hljs-params">(handler)</span> -&gt;</span> <span class="hljs-property">@handle</span> handler
        <span class="hljs-attribute">receive</span>: <span class="hljs-function"><span class="hljs-params">(handler)</span> -&gt;</span> <span class="hljs-property">@handle</span> handler
        <span class="hljs-attribute">handle</span>: <span class="hljs-function"><span class="hljs-params">(handler)</span> -&gt;</span>
            <span class="hljs-property">@_props</span>.scraper.handler = handler
            @

        <span class="hljs-attribute">properties</span>: <span class="hljs-function"><span class="hljs-params">(props...)</span> -&gt;</span> <span class="hljs-property">@members</span> props
        <span class="hljs-attribute">members</span>: <span class="hljs-function"><span class="hljs-params">(properties...)</span> -&gt;</span>
            <span class="hljs-property">@_props</span>.scraper.properties = []
            <span class="hljs-function"><span class="hljs-title">traverse</span> = <span class="hljs-params">(props)</span> =&gt;</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> props <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> props <span class="hljs-keyword">instanceof</span> Array <span class="hljs-keyword">and</span> props.length &gt; <span class="hljs-number">0</span>
                    <span class="hljs-keyword">for</span> prop <span class="hljs-keyword">in</span> props
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> prop <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
                            <span class="hljs-keyword">if</span> nodeProperties.indexOf(prop) &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid property: <span class="hljs-subst">#{prop}</span>"</span>
                            <span class="hljs-property">@_props</span>.scraper.properties.push prop
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> prop <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
                            traverse prop
            traverse properties
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Terms that have no effect but lend a more fluent feel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">and</span>:<span class="hljs-function"> -&gt;</span> @
        <span class="hljs-attribute">then</span>:<span class="hljs-function"> -&gt;</span> @
        <span class="hljs-attribute">of</span>:<span class="hljs-function"> -&gt;</span> @
        <span class="hljs-attribute">with</span>:<span class="hljs-function"> -&gt;</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Build a request object as described</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">build</span>:<span class="hljs-function"> -&gt;</span>
            req = <span class="hljs-keyword">new</span> Request</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Assign the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> <span class="hljs-property">@_props</span>.url <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> req.url <span class="hljs-property">@_props</span>.url</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Handle timeouts and other errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@_props</span>.timeout.duration? <span class="hljs-keyword">and</span> <span class="hljs-property">@_props</span>.timeout.duration &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> req.timeout <span class="hljs-property">@_props</span>.timeout.duration
            req.<span class="hljs-literal">on</span> events.TIMEOUT, <span class="hljs-property">@_props</span>.timeout.handler
            req.<span class="hljs-literal">on</span> events.REQUEST_FAILURE, <span class="hljs-property">@_props</span>.timeout.handler</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Build an appropriate sentry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">switch</span> <span class="hljs-property">@_build</span>.<span class="hljs-keyword">when</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>CSS selector is generated by when()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">when</span> builders.<span class="hljs-keyword">when</span>.<span class="hljs-reserved">function</span>, builders.<span class="hljs-keyword">when</span>.css
                    req.condition <span class="hljs-property">@_props</span>.condition.callback, <span class="hljs-property">@_props</span>.condition.argument</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Build an action to invoke when ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">switch</span> <span class="hljs-property">@_build</span>.action
                <span class="hljs-keyword">when</span> builders.action.<span class="hljs-reserved">function</span>, builders.action.evaluate
                    req.action <span class="hljs-property">@_props</span>.action
                
                <span class="hljs-keyword">when</span> builders.action.parts
                    extractor = <span class="hljs-property">@_props</span>.scraper.extractor
                    handler = <span class="hljs-property">@_props</span>.scraper.handler
                    argument = <span class="hljs-property">@_props</span>.scraper.argument
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> argument <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">then</span> argument = <span class="hljs-string">''</span>

                    req.action <span class="hljs-function"><span class="hljs-params">(page)</span> -&gt;</span>
                        pg = page
                        <span class="hljs-function"><span class="hljs-title">withPageContext</span> = <span class="hljs-params">(args...)</span> -&gt;</span>
                            args.push pg
                            handler.apply(@, args)

                        page.evaluate extractor, withPageContext, argument

                <span class="hljs-keyword">when</span> builders.action.css
                    args =
                        <span class="hljs-attribute">query</span>: <span class="hljs-property">@_props</span>.scraper.query
                        <span class="hljs-attribute">preserve</span>: <span class="hljs-property">@_props</span>.scraper.properties
                    
                    handler = <span class="hljs-property">@_props</span>.scraper.handler

                    <span class="hljs-function"><span class="hljs-title">extractor</span> = <span class="hljs-params">(args)</span> -&gt;</span>
                        <span class="hljs-function"><span class="hljs-title">filter</span> = <span class="hljs-params">(elems)</span> -&gt;</span>
                            results = []
                            <span class="hljs-keyword">for</span> elem <span class="hljs-keyword">in</span> elems <span class="hljs-keyword">when</span> elem.id?
                                obj = {}
                                <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> args.preserve
                                    <span class="hljs-keyword">if</span> key <span class="hljs-keyword">is</span> <span class="hljs-string">'children'</span> <span class="hljs-keyword">or</span> key <span class="hljs-keyword">is</span> <span class="hljs-string">'childNodes'</span>
                                        obj[key] = filter(elem[key])
                                    <span class="hljs-keyword">else</span>
                                        obj[key] = elem[key]

                                results.push obj

                            results

                        filter <span class="hljs-built_in">document</span>.querySelectorAll(args.query)
                    
                    req.action <span class="hljs-function"><span class="hljs-params">(page)</span> -&gt;</span> 
                        pg = page
                        <span class="hljs-function"><span class="hljs-title">withPageContext</span> = <span class="hljs-params">(args...)</span> -&gt;</span>
                            args.push pg
                            handler.apply(@, args)
                        page.evaluate extractor, withPageContext, args
                    

            req</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Build and immediately execute a request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">execute</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> url <span class="hljs-keyword">isnt</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@from</span> url
            req = <span class="hljs-property">@build</span>()
            req.execute()
            req</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>A request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Private method to clean up open Phantom instances and notify listeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-title">end</span> = -&gt;</span>
            <span class="hljs-property">@emit</span> events.FINISH
            clearInterval <span class="hljs-property">@_interval</span>

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> <span class="hljs-property">@_onFinish</span> <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
                <span class="hljs-property">@_onFinish</span>()

            <span class="hljs-keyword">if</span> <span class="hljs-property">@_closeWhenFinished</span> <span class="hljs-keyword">and</span> connection.supportsAutoClose
                <span class="hljs-property">@_phantom</span>.exit()

        <span class="hljs-function"><span class="hljs-title">log</span> = <span class="hljs-params">(msg)</span> -&gt;</span>
            <span class="hljs-built_in">console</span>.log msg

        <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@_url</span> = <span class="hljs-string">''</span>
            <span class="hljs-property">@_condition</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_action</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_interval</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_phantom</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_page</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_onFinish</span> = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_timeout</span> = <span class="hljs-number">3000</span>
            <span class="hljs-property">@_bindConsole</span> = <span class="hljs-literal">false</span>
            <span class="hljs-property">@_debug</span> = <span class="hljs-literal">false</span>
            <span class="hljs-property">@_closeWhenFinished</span> = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Add a callback that must return true before emitting ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">condition</span>: <span class="hljs-function"><span class="hljs-params">(callback, argument)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid condition"</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> argument <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span> <span class="hljs-keyword">then</span> argument = <span class="hljs-literal">null</span>
            <span class="hljs-property">@_condition</span> =
                <span class="hljs-attribute">callback</span>: callback
                <span class="hljs-attribute">argument</span>: argument
            <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Add an action to be performed whenc ontent is ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">action</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">isnt</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid action"</span>
            <span class="hljs-property">@_action</span> = callback
            <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Set or get the timeout value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">timeout</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'number'</span>
                <span class="hljs-property">@_timeout</span> = value
                <span class="hljs-keyword">this</span>
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_timeout</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Automaticaly close Phantom when finished</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">closeWhenFinished</span>: <span class="hljs-function"><span class="hljs-params">(close)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> close <span class="hljs-keyword">is</span> <span class="hljs-string">'boolean'</span>
                <span class="hljs-property">@_closeWhenFinished</span> = close
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_closeWhenFinished</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Toggle binding console.log to the PhantomJS instanceâ€™s console.log.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">console</span>: <span class="hljs-function"><span class="hljs-params">(bind)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> bind <span class="hljs-keyword">is</span> <span class="hljs-string">'boolean'</span>
                <span class="hljs-property">@_bindConsole</span> = bind
                <span class="hljs-keyword">if</span> <span class="hljs-property">@_bindConsole</span>
                    <span class="hljs-property">@addListener</span> events.CONSOLE, log
                <span class="hljs-keyword">else</span>
                    <span class="hljs-property">@removeListener</span> events.CONSOLE, log
                @

            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_bindConsole</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Enable or disable debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">debug</span>: <span class="hljs-function"><span class="hljs-params">(isOn)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> isOn <span class="hljs-keyword">is</span> <span class="hljs-string">'boolean'</span>
                <span class="hljs-property">@_debug</span> = isOn
                
                <span class="hljs-keyword">for</span> key, event <span class="hljs-keyword">of</span> events
                    <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(event)</span> -&gt;</span>
                        <span class="hljs-function"><span class="hljs-title">callback</span> = -&gt;</span> <span class="hljs-built_in">console</span>.log <span class="hljs-string">'DEBUG: '</span> + event

                        <span class="hljs-keyword">if</span> <span class="hljs-property">@_debug</span>
                            <span class="hljs-property">@addListener</span> event, callback
                        <span class="hljs-keyword">else</span>
                            <span class="hljs-property">@removeListener</span> event, callback
                @

            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_debug</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Set or get the URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">url</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> url == <span class="hljs-string">'string'</span>
                <span class="hljs-property">@_url</span> = url
                <span class="hljs-keyword">this</span>
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@_url</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Interrupt execution and end ASAP</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">halt</span>:<span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@emit</span> events.HALT
            end.call <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Execute the request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-attribute">execute</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
            <span class="hljs-property">@url</span> url   <span class="hljs-comment"># Set the URL if it was provided</span>

            connection.open <span class="hljs-function"><span class="hljs-params">(ph, doneWithConnection)</span> =&gt;</span>
                <span class="hljs-property">@_onFinish</span> = doneWithConnection</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>ph.set(â€˜onErrorâ€™, =&gt; @emit events.REQUEST_FAILURE)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-property">@_phantom</span> = ph
                <span class="hljs-property">@emit</span> events.PHANTOM_CREATE
                
                ph.createPage <span class="hljs-function"><span class="hljs-params">(page)</span> =&gt;</span>
                    <span class="hljs-property">@_page</span> = page
                    page.set<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'onConsoleMessage'</span>, (msg) =&gt; <span class="hljs-property">@emit</span> events.CONSOLE, msg)</span>
                    <span class="hljs-title">page</span>.<span class="hljs-title">set</span><span class="hljs-params">(<span class="hljs-string">'onError'</span>, =&gt; <span class="hljs-property">@emit</span> events.REQUEST_FAILURE)</span>

                    @<span class="hljs-title">emit</span> <span class="hljs-title">events</span>.<span class="hljs-title">PAGE_CREATE</span>

                    <span class="hljs-title">page</span>.<span class="hljs-title">open</span> @<span class="hljs-title">_url</span>, <span class="hljs-params">(status)</span> =&gt;</span>
                        <span class="hljs-keyword">if</span> (status != <span class="hljs-string">'success'</span>)        <span class="hljs-comment"># Request failed</span>
                            <span class="hljs-property">@emit</span> events.REQUEST_FAILURE
                            end.call <span class="hljs-keyword">this</span>

                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_condition</span> <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>    <span class="hljs-comment"># Request succeeded, but we have to verify the DOM</span>
                            start = now()</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>This function is called over and over until all conditions 
have been satisfied or we run out of time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-function"><span class="hljs-title">tick</span> = =&gt;</span>
                                <span class="hljs-property">@emit</span> events.CHECKING</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> <span class="hljs-property">@_timeout</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> now() - start &gt; <span class="hljs-property">@_timeout</span>
                                    <span class="hljs-property">@emit</span> events.TIMEOUT
                                    end.call <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Check sentry and perform action if ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">else</span>
                                    <span class="hljs-function"><span class="hljs-title">handler</span> = <span class="hljs-params">(result)</span> =&gt;</span>
                                        <span class="hljs-keyword">if</span> result
                                            <span class="hljs-property">@emit</span> events.READY
                                            <span class="hljs-property">@_action</span>(page)
                                            end.call <span class="hljs-keyword">this</span>

                                    page.evaluate <span class="hljs-property">@_condition</span>.callback, handler, <span class="hljs-property">@_condition</span>.argument


                            <span class="hljs-keyword">if</span> <span class="hljs-property">@_timeout</span> &gt;= <span class="hljs-number">0</span>
                                <span class="hljs-property">@_interval</span> = setInterval tick, <span class="hljs-number">250</span>
                            tick()

                        <span class="hljs-keyword">else</span>                            <span class="hljs-comment"># Request succeeded and no verifications necessary - proceed!</span>
                            <span class="hljs-property">@emit</span> events.READY
                            <span class="hljs-property">@_action</span>(page)
                            end.call <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Ensure that Request can emit events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Request.prototype.__proto__ = Emitter.prototype</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Export bound classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">exports</span> =
        <span class="hljs-string">"Request"</span>: Request
        <span class="hljs-string">"Builder"</span>: Builder
        <span class="hljs-string">"create"</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> Builder
        <span class="hljs-string">"events"</span>: events
        <span class="hljs-string">"recycle"</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> val <span class="hljs-keyword">then</span> connection = <span class="hljs-keyword">new</span> RecycledPhantomStrategy
            <span class="hljs-keyword">else</span> connection = <span class="hljs-keyword">new</span> NewPhantomStrategy
        
        <span class="hljs-string">"ConnectionStrategy"</span>:    <span class="hljs-comment"># Deprecated</span>
            <span class="hljs-attribute">RoundRobin</span>: RoundRobinPhantomStrategy
            <span class="hljs-attribute">New</span>: NewPhantomStrategy
            <span class="hljs-attribute">NewPort</span>: NewPortPhantomStrategy
            <span class="hljs-attribute">Recycled</span>: RecycledPhantomStrategy
            <span class="hljs-attribute">Random</span>: RandomPhantomStrategy
        <span class="hljs-attribute">setConnectionStrategy</span>: <span class="hljs-function"><span class="hljs-params">(strategy)</span> -&gt;</span> <span class="hljs-comment"># Deprecated</span>
            <span class="hljs-keyword">if</span> strategy <span class="hljs-keyword">instanceof</span> PhantomStrategy
                connection = strategy
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid connection strategy"</span>

        <span class="hljs-string">"RoundRobin"</span>: RoundRobinPhantomStrategy
        <span class="hljs-string">"RandomPool"</span>: RandomPhantomStrategy
        <span class="hljs-string">"NewPhantom"</span>: NewPhantomStrategy
        <span class="hljs-string">"NewPhantomAndPort"</span>: NewPortPhantomStrategy
        <span class="hljs-string">"RecycledPhantom"</span>: RecycledPhantomStrategy
        <span class="hljs-string">"connections"</span>:<span class="hljs-function"> -&gt;</span> connection
        <span class="hljs-string">"connectWith"</span>: <span class="hljs-function"><span class="hljs-params">(strategy)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> strategy <span class="hljs-keyword">instanceof</span> PhantomStrategy
                connection = strategy
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Invalid connection strategy"</span>
        

<span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = binder()
<span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span>.inject = binder</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
